using System;
using System.Collections.Generic;
using System.Linq;
using BlazorDemo.Models;

namespace BlazorDemo.Data
{
    public class PhotoUploader
    {
        private const string unsplashBaseUrl = "https://images.unsplash.com/photo-";
        private const string unsplashQueryStr = "?auto=format&fit=crop&h=540&w=960&q=20";
        private static readonly string[] photos = new string[]
            {
                "1572295727871-7638149ea3d7",
                "1571847490051-491c12ff6540",
                "1571586100122-0869bd6e77c9",
                "1542033644763-2354d1e19f63",
                "1571217668979-f46db8864f75",
                "1570942872213-1242607a35eb"
            };

        private Random rand = new Random();

        private static readonly string[] allPhotos = new string[]
            {
                "1574001412367-cf5f9756bb32","1573380499247-58e22435fcfb","1572219479068-8a05d5310ba1","1571586100127-cdaef780fc61","1571217668979-f46db8864f75","1573867368999-5388ba407550","1573551013875-a54c2a879deb","1571993192866-202f70b7ec7e","1571586100122-0869bd6e77c9","1571423039463-fd8a8b93b33e","1573743338941-39db12ef9b64","1573554394544-930a4cf6fc66","1573332039392-b66bd2bfa5bf","1572295727871-7638149ea3d7","1571847490051-491c12ff6540","1571680719972-f18bb57077cf","1571406252288-cc9c25bb4a44","1570942872213-1242607a35eb","1569441553317-7439fc01e319","1570171278960-d6c2b316f3b1","1569685915250-01b72923ca1c","1569524872948-0ba4d096f997","1569398034126-476b0d96e2d1","1569251200481-5df7232856ef","1569261995036-70d0dd50be24","1571210059434-edf0dc48e414","1568495824441-a2052db83f64","1570121962635-3552954619a6","1569825724462-71e5e1d3f68d","1569493086584-33e0b36f3145","1569430044663-054ffc0c50c5","1569402604464-6f466a53141e","1569191086551-b3606745884f","1571030439710-121569126a76","1569683795645-b62e50fbf103","1569834381156-7b735e41e57d","1569365788898-f96aa58c27eb","1569432612267-72ad7e2e4e8e","1569346332452-876d0eef389f","1569252376476-f252109a526d","1569243963117-78bb6e7ff948","1569243953918-4347e3038d14","1568860484667-b78d64242041","1569173784625-34f37a1a35ef","1569173784307-3c9681b8c8a6","1569261230225-e0d58c2342c3","1569241786334-1214c0f1f3bd","1568402128879-fe6b7755a63b","1569172447357-49091856486b","1569172447370-bc43789ba361","1568757249312-096bc0798561","1568322714397-333fc0b6f229","1569196769169-148d853ee706","1567913300214-364d5256df1c","1568128979147-e03add161edb","1568216838236-0e791099ba97","1568283096533-078a24930eb8","1568402129481-dd0943849985","1568473648251-3a0c3aa56192","1567647753830-de3fe7ce9f28","1512229146678-994d3f1e31bf","1568214697537-ace27ffd6cf3","1568405336404-1fefdca58699","1568312442641-d6c790fdf0f6","1567117068494-1cb546a001ad","1561623497-a2f891b6eda5","1568021735466-efd8a4c435af","1568164528001-fdf61ebe1a7e","1568233823082-873ab0156ad7","1568420162086-b16456b8d557","1567637903900-7a2f05e37e1a","1446080501695-8e929f879f2b","1443926818681-717d074a57af","1532996078953-a13fa6d622cb","1499002238440-d264edd596ec","1530693239081-c7918180089c","1566405382187-a5937a822773","1566526637242-ec13c43bc455","1482005253821-5d6a2c685879","1534801189582-810af28d898b","1557906858-1bdc35fc75e5","1557479121-dcb22614fb91","1564053489984-317bbd824340","1556849260-8f8dc1a56d00","1530625243345-797b4c1836ee","1566500304829-707d59cb22a1","1566305828756-cacc74d3dd20","1559164314-d0b3de46e8d1","1554320666-c12ac6076837","1564053489865-3f7ddbf8551b","1532996228489-082708ddbde0","1497367917223-64c44836be50","1566764619071-ee3076202587","1566545455366-bcae28fd3929","1484504110495-939e9baca603","1501084291732-13b1ba8f0ebc","1559350296-7f363b66b16a","1557689536-1dd254e4dc75","1555454762-24a52b98f75f","1464800959563-472c0567132f","1550853875-7475e82fddba","1565378434747-262417385c7f","1497290756760-23ac55edf36f","1519582149095-fe7d19b2a3d2","1461397821064-32d6b3c91b9f","1470115493989-233e397d5930","1414546017025-34e6468be913","1565367267466-29c9004fc71f","1510266869518-a1f83158da96","1565378435217-e4a764b19d0d","1565466662941-e8fb2742c855","1502807521734-c36e42763f7d","1428550590922-34c77f716ad4","1465374142464-8984179505b2","1480114440414-43a37cc4472f","1483425571841-9662f86c7154","1563195127-681ff3349549","1563303042-b9fe51ff7227","1502947830258-6ad0b35bb348","1565378435245-4282cbde883e","1565607473757-36c42300cea6","1509994450972-7e006330fa95","1485470733090-0aae1788d5af","1461230185679-aad82a673415","1461352195749-fdba50b79c74","1465189684280-6a8fa9b19a7a","1462290625486-c142817fb94d","1563216368-5b6a40648062","1560269570-bb65ba82fcf6","1563468415006-0b70ca8eb306","1560728827-1910835c6761","1563858272990-ee61741967f6","1563427777882-8c6e10fa4920","1563569612166-d2aaeaaa5294","1563673708858-3a0680eaf5d3","1563646777010-2970e09a93ba","1563342294-3663a0396b8e","1563454758691-702be3d2e2b6","1563667151712-99677e902c4f","1563603061079-a251ad668313","1560815633-37d240814f3d","1563647472522-de4e25341a57","1562874724-b33411b38141","1562824429-7c023697286d","1562386130-926081dc4fbf","1564694245232-0a1ad9f3cd38","1564612123554-78943ddb2ba3","1563759553854-95ea771b8932","1562741665-50c9e0187e82","1562447279-69402cb4587d","1563863016472-d41d0fbe1056","1563740553614-7d97452e871a","1563930365798-3014c158554f","1562592199-8aed6ae5252d","1562841883-85e49a4c02c8","1562670652-e5947bddb335","1562337589-136d8a7dd9dd","1561363702-e07252da3399","1490682143684-14369e18dce8","1442606440995-d0be22c5f90f","1445964047600-cdbdb873673d","1440688807730-73e4e2169fb8","1462923069008-41fd25cb2a21","1462842846914-31ab9f19373a","1444090542259-0af8fa96557e","1492011221367-f47e3ccd77a0","1416169607655-0c2b3ce2e1cc","1462275646964-a0e3386b89fa","1439853949127-fa647821eba0","1462842349122-2982a4d79c5d","1462834444171-02eff1c2a426","1462717585237-7fafe19c5448","1452723312111-3a7d0db0e024","1450101215322-bf5cd27642fc","1432256851563-20155d0b7a39","1443527216320-7e744084f5a7","1462984932903-94693e5d5fca","1462826971377-c033341482bb","1561180671-f1e7cac00dd6","1560372610-931c8343bc43","1560345573-9f453083c335","1560382797-66b2d275cb56","1560241692-f4f0432ced72","1559657693-e816ff3bd9af","1559666126-84f389727b9a","1560146491-bf5035f649fa","1561023435-76d23e8ff6de","1559160581-44bd4222d397","1560386797-04b5d3ef6eb7","1560310948-c87704426162","1559852865-d60f753c05ab","1560146491-308b0f69a52a","1462819067004-905a72ea3996","1558869031-49d71660e2d5","1559186351-a948a50159bd","1560336767-9bb468f204c0","1560268292-d23802753f4d","1559967861-360333071389","1560121160-d0d230141128","1560082020-029ec0709721","1556184059-ee5b45067ad4","1558682383-95b6124e65a2","1557474295-714ea5fc2557","1557626204-59dd03fd2d31","1557832015-ab80f61fdf27","1557163123-abbafe113238","1523295475921-ca5ea3d129a9","1523295616404-2b6c098f26dd","1559626627-cb31b201e27f","1559318175-7b25de8ce097","1557292882-c911bef21523","1557389352-e721da78ad9f","1557502706-5a0e03129173","1557652646-c4efca50f2de","1557600280-9ceddf1a3cc3","1418393781697-0215e2fd73e4","1523295661460-883355faa079","1559493909-41312d8b0c4d","1558879177-69cde6b279c7","1557943819-b09ae5a1375c","1557633758-b4834d3e7f90","1557562440-b67d58679232","1557684288-7d12c79129bb"
            };

        public List<Photo> GetPhotos()
        {
            var limit = rand.Next(20, 30); // photos.Length;
            var timestamps = GetTimestamps(DateTime.Today, limit);

            return Shuffle(allPhotos).Take(limit).Select((url, i) => new Photo(unsplashBaseUrl + url + unsplashQueryStr, timestamps[i])).ToList();
        }

        private List<string> GetTimestamps(DateTime today, int count)
        {
            var sessionGenerator = new SessionGenerator();

            sessionGenerator.AddTimeframe(today.AddDays(-3).AddHours(08), TimeSpan.FromHours(2), 3);
            sessionGenerator.AddTimeframe(today.AddDays(-2).AddHours(13), TimeSpan.FromHours(2), 1);
            sessionGenerator.AddTimeframe(today.AddDays(-2).AddHours(17), TimeSpan.FromHours(5), 3);
            sessionGenerator.AddTimeframe(today.AddDays(-1).AddHours(09), TimeSpan.FromHours(3), 2);

            return sessionGenerator.GetTimestamps(count+1);
        }

        private IList<T> Shuffle<T>(IList<T> list)
        {
            int n = list.Count;
            while (n > 1)
            {
                n--;
                int k = rand.Next(n + 1);
                T value = list[k];
                list[k] = list[n];
                list[n] = value;
            }

            return list;
        }

        private class SessionGenerator
        {
            private List<SessionTimeframe> _timeframes = new List<SessionTimeframe>();
            private double TotalWeight => _timeframes.Sum(tf => (double)tf.Weight);

            public void AddTimeframe(DateTime start, TimeSpan duration, int weight)
            {
                _timeframes.Add(new SessionTimeframe() { Start = start, End = start.Add(duration), Weight = weight });
            }

            public List<string> GetTimestamps(int totalCount)
            {
                var rand = new Random();

                return _timeframes.SelectMany(tf =>
                {
                    var count = (int)Math.Round(totalCount * (tf.Weight / TotalWeight));

                    var lastPhoto = tf.Start;
                    var range = (int)Math.Round((tf.End - tf.Start).TotalMinutes / (count + 1), 0);

                    return Enumerable.Range(0, count).Select(i =>
                    {
                        lastPhoto = lastPhoto.Add(TimeSpan.FromSeconds(rand.Next(60, range*60)));
                        return lastPhoto.ToString();
                    });
                }).Take(totalCount).ToList();
            }
        }

        private class SessionTimeframe
        {
            public DateTime Start { get; set; }
            public DateTime End { get; set; }
            public int Weight { get; set; }
        }
    }
}
